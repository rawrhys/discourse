<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.healthy {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        button.success {
            background-color: #28a745;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.warning {
            background-color: #ffc107;
            color: #212529;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            resize: vertical;
        }
        .test-results {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .log.info {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        .log.success {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        .log.warning {
            background-color: #fff8e1;
            color: #f57c00;
        }
        .log.error {
            background-color: #ffebee;
            color: #c62828;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enhanced TTS Test Page</h1>
        
        <!-- Health Status Section -->
        <div class="section">
            <h2>Health Status</h2>
            <div id="healthStatus" class="status">
                Checking TTS health...
            </div>
            <button onclick="checkHealth()">Refresh Health</button>
            <button onclick="runAllTests()" class="success">Run All Tests</button>
        </div>

        <!-- Basic TTS Test Section -->
        <div class="section">
            <h2>Basic TTS Test</h2>
            <textarea id="testText" placeholder="Enter text to speak...">This is a test of the enhanced text-to-speech system. The TTS service has been improved with better error handling, browser compatibility, and reliability features.</textarea>
            <div class="controls">
                <button onclick="speakText()">Speak Text</button>
                <button onclick="pauseSpeech()" class="warning">Pause</button>
                <button onclick="resumeSpeech()" class="warning">Resume</button>
                <button onclick="stopSpeech()" class="danger">Stop</button>
            </div>
            <div class="progress">
                <div id="speechProgress" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <!-- Service Status Section -->
        <div class="section">
            <h2>Service Status</h2>
            <div id="serviceStatus" class="status">
                Loading service status...
            </div>
            <button onclick="refreshStatus()">Refresh Status</button>
            <button onclick="forceReinitialize()" class="warning">Force Reinitialize</button>
        </div>

        <!-- Test Results Section -->
        <div class="section">
            <h2>Test Results</h2>
            <button onclick="clearLogs()" class="danger">Clear Logs</button>
            <div id="testResults" class="test-results">
                <div class="log info">TTS Test Page loaded. Ready to test enhanced TTS functionality.</div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the TTS services and test utility
        import { privateTTSService, publicTTSService, ttsServiceFactory } from '../src/services/TTSService.js';
        import ttsTest from '../src/utils/ttsTest.js';

        // Make services available globally for testing
        window.privateTTSService = privateTTSService;
        window.publicTTSService = publicTTSService;
        window.ttsServiceFactory = ttsServiceFactory;
        window.ttsTest = ttsTest;

        // Global variables
        let isSpeaking = false;
        let speechStartTime = 0;
        let speechDuration = 0;
        let progressInterval = null;

        // Logging function
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(logDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // Health check function
        window.checkHealth = async function() {
            log('Running health check...', 'info');
            const healthStatus = document.getElementById('healthStatus');
            healthStatus.textContent = 'Checking...';
            healthStatus.className = 'status';

            try {
                const health = await ttsTest.quickHealthCheck();
                
                if (health.isHealthy) {
                    healthStatus.textContent = '✓ TTS is healthy and ready';
                    healthStatus.className = 'status healthy';
                    log('TTS health check passed', 'success');
                } else {
                    healthStatus.textContent = '✗ TTS has issues - check details below';
                    healthStatus.className = 'status error';
                    log('TTS health check failed', 'error');
                    
                    if (!health.browserSupported) {
                        log('Browser does not support speech synthesis', 'error');
                    }
                    if (!health.initialized) {
                        log('TTS service not initialized', 'warning');
                    }
                    if (health.errorCount > 0) {
                        log(`TTS has ${health.errorCount} errors`, 'warning');
                    }
                }
            } catch (error) {
                healthStatus.textContent = '✗ Health check failed';
                healthStatus.className = 'status error';
                log(`Health check error: ${error.message}`, 'error');
            }
        };

        // Run all tests function
        window.runAllTests = async function() {
            log('Starting comprehensive TTS tests...', 'info');
            const results = await ttsTest.runAllTests();
            log(`Tests completed: ${results.passed}/${results.total} passed`, results.passed === results.total ? 'success' : 'warning');
        };

        // Speak text function
        window.speakText = async function() {
            const text = document.getElementById('testText').value.trim();
            if (!text) {
                log('No text to speak', 'warning');
                return;
            }

            try {
                log(`Speaking text: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`, 'info');
                
                // Start speaking
                await privateTTSService.speak(text);
                
                // Start progress tracking
                startProgressTracking();
                
                log('Speech started successfully', 'success');
            } catch (error) {
                log(`Speech error: ${error.message}`, 'error');
            }
        };

        // Pause speech function
        window.pauseSpeech = function() {
            privateTTSService.pause();
            log('Speech paused', 'info');
        };

        // Resume speech function
        window.resumeSpeech = function() {
            privateTTSService.resume();
            log('Speech resumed', 'info');
        };

        // Stop speech function
        window.stopSpeech = function() {
            privateTTSService.stop();
            stopProgressTracking();
            log('Speech stopped', 'info');
        };

        // Refresh status function
        window.refreshStatus = function() {
            const status = privateTTSService.getStatus();
            const statusDiv = document.getElementById('serviceStatus');
            
            let statusText = '';
            let statusClass = 'status';
            
            if (status.isInitialized) {
                statusText = `✓ Service initialized | Playing: ${status.isPlaying} | Paused: ${status.isPaused} | Errors: ${status.errorCount}`;
                statusClass = status.errorCount === 0 ? 'status healthy' : 'status warning';
            } else {
                statusText = `✗ Service not initialized | Browser support: ${status.browserSupport.speechSynthesis}`;
                statusClass = 'status error';
            }
            
            statusDiv.textContent = statusText;
            statusDiv.className = statusClass;
            
            log(`Status refreshed: ${statusText}`, 'info');
        };

        // Force reinitialize function
        window.forceReinitialize = async function() {
            log('Force reinitializing TTS service...', 'info');
            try {
                await privateTTSService.forceReinitialize();
                log('Force reinitialization completed', 'success');
                refreshStatus();
            } catch (error) {
                log(`Reinitialization error: ${error.message}`, 'error');
            }
        };

        // Clear logs function
        window.clearLogs = function() {
            document.getElementById('testResults').innerHTML = '';
            log('Logs cleared', 'info');
        };

        // Progress tracking functions
        function startProgressTracking() {
            isSpeaking = true;
            speechStartTime = Date.now();
            speechDuration = 0;
            
            progressInterval = setInterval(() => {
                if (isSpeaking) {
                    speechDuration = Date.now() - speechStartTime;
                    const progress = Math.min((speechDuration / 10000) * 100, 100); // Assume 10 seconds for progress
                    document.getElementById('speechProgress').style.width = `${progress}%`;
                }
            }, 100);
        }

        function stopProgressTracking() {
            isSpeaking = false;
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            document.getElementById('speechProgress').style.width = '0%';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('TTS Test Page initialized', 'success');
            
            // Run initial health check
            setTimeout(() => {
                checkHealth();
                refreshStatus();
            }, 1000);
            
            // Set up status monitoring
            setInterval(() => {
                if (isSpeaking) {
                    const status = privateTTSService.getStatus();
                    if (!status.isPlaying && !status.isPaused) {
                        stopProgressTracking();
                        log('Speech completed', 'success');
                    }
                }
            }, 1000);
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            privateTTSService.stop();
            if (progressInterval) {
                clearInterval(progressInterval);
            }
        });
    </script>
</body>
</html>
